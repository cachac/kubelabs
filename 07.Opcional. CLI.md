# 7. CLI comandos rápidos <!-- omit in toc -->

En ocasiones, abrir y editar archivos YAML en consola puede ser lento y tedioso. Conocer los comandos de `kubectl` acelera tareas comunes y te ayuda a entender mejor los objetos de Kubernetes.

Para automatización (CI/CD) lo ideal es usar manifiestos y pipelines, no repetir comandos manualmente. Aun así, dominar el CLI es útil y recomendado para certificaciones.

Prerequisitos rápidos:
- Tener un clúster funcional (Kind, Minikube, k3s o un cluster administrado) y `kubectl` configurado (`kubectl cluster-info`).


Objetivo:

- Usar el CLI para crear y gestionar objetos de Kubernetes.


# 1. Crear un Namespace
```bash
kubectl create ns demo
```

# 2. Usar el namespace demo
```bash
kubectl config set-context --current --namespace=demo
```

- También puede usar kubens.

# 3. Crear un pod de imagen nginx
```bash
kubectl run myapp-pod --image=nginx

kubectl get pods
```

# 2. Generar un archivo YAML

```bash
kubectl run myapp-pod --image=nginx --dry-run=client -o yaml
```
> -o yaml = muestra en pantalla la configuración del objeto.

> --dry-run=client = no crea el objeto, solamente simula su creación.

# 3. Crear un Deployment
```bash
kubectl create deployment --image=nginx nginx-deploy
```

# 4. Generar el YAML del Deployment en consola
```bash
kubectl create deployment --image=nginx nginx-deploy --dry-run=client -o yaml
```
# 5. Validar el Deployment
```bash
kubectl get deploy -o wide
```
> -o wide = muestra mas información.


# 6. Generar un Deployment con 4 Replicas y bajar a un archivo YAML llamado nginx-deployment.yaml

```bash
kubectl create deployment --image=nginx nginx-deploy --replicas=4 --dry-run=client -o yaml > nginx-deployment.yaml
```
> --replicas=4

> --dry-run=client

> -o yaml > ***nginx-deployment.yaml*** = exporta a un archivo

# 7. Crear un objeto basado en el archivo descargado
```bash
kubectl apply -f nginx-deployment.yaml
```
Error conocido:
> error when creating "nginx-deployment.yaml": deployments.apps "nginx-deploy" already exists

> Sí presenta el error anterior se debe eliminar el deploy `nginx-deploy` y volver a aplicar:
```bash
kubectl delete deployment nginx-deploy
kubectl apply -f nginx-deployment.yaml
```

# 8. Recrear los pods del deployment
```bash
kubectl rollout restart deployment nginx-deploy
```
> Listar los Pod y revisar la fecha

# 9. TEST: Investigar en kubernetes.io
## 9.1. Escalar a dos replicas
```bash
# Pista: kubectl scale deployment <name> --replicas=2
kubectl scale deployment nginx-deploy --replicas=2
kubectl get deploy nginx-deploy -o wide
kubectl get rs
kubectl get pods -w
```

# 10. Limpiar
```bash
# Recomendado: limpiar SOLO el Namespace de práctica
kubectl delete all --all -n demo
# Si creaste objetos con otros tipos (configmaps, secrets, pvc, etc.):
kubectl delete cm,secret,pvc --all -n demo
```
> Evita usar `kubectl delete all --all` sin Namespace: afecta todos los Namespaces. Nunca ejecutarlo en Producción.


# 11. Labels - Selectors

> [Documentación Oficial](https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/)

## 11.1. Crear el archivo label-demo.yaml
> [label-demo.yml](./assets/label-demo.yml)

```yaml
apiVersion: apps/v1
kind: Deployment

metadata:
  namespace: demo
  name: label-demo-api-prod
  labels:
    app: labeldemo

spec:
  replicas: 3

  selector:
    matchLabels:
      app: rrhh
      type: api
      env: production

  template:
    metadata:
      name: label-demo-api-prod
      labels:
        app: rrhh
        type: api
        env: producction
        #  Revisar y corregir el error.
    spec:
      containers:
      - name: nginx
        image: nginx:1.14.2
        ports:
        - containerPort: 80
---
apiVersion: apps/v1
kind: Deployment

metadata:
  name: label-demo-api-dev
  labels:
    app: labeldemo

spec:
  replicas: 2

  selector:
    matchLabels:
      app: rrhh
      type: api
      env: dev

  template:
    metadata:
      name: label-demo-api-dev
      labels:
        app: rrhh
        type: api
        env: dev
    spec:
      containers:
      - name: nginx
        image: nginx:1.14.2
        ports:
        - containerPort: 80
```
> este archivo tiene dos deployments concatenados con los símbolos "---"

> TIP: las etiquetas del match labels no coinciden.


```bash
kubectl apply -f label-demo.yaml
```
## 11.2. Corregir el error:
> map[string]string{"app":"rrhh", "type":"api"}: `selector` does not match template `labels`
```bash
# Edita y corrige para que selector.matchLabels == template.metadata.labels
# (por ejemplo, corrige env: producction -> production, o ajusta el selector)
kubectl apply -f label-demo.yaml
kubectl get deploy -o wide
kubectl get pods --show-labels
```

## 11.3. Listar los Pods
```bash
kubectl get pods --show-labels
```

## 11.4. Listar los PODs por label
> "-l" filtra por etiquetas
```bash
kubectl get pods -l env=production
```

## 11.5. Contar cuantos PODs tienen la etiqueta:
```bash
kubectl get pods -l env=production --no-headers | wc -l
```
> Tenemos 3 PODs

## 11.6. Filtrar por múltiples labels separando por coma (,):
```bash
kubectl get pods -l app=rrhh,env=dev
```

> Tenemos 2 PODs


[Etiquetas recomendadas](https://kubernetes.io/docs/concepts/overview/working-with-objects/common-labels/)


# 12. Limpiar
```bash
# Limpiar el namespace de práctica (si lo usaste)
kubectl delete all --all -n demo
```
